@page "/document/{documentId:int}/approval"
@rendermode InteractiveServer
@attribute [Authorize];

<PageTitle>Согласование документов</PageTitle>

<div class="container m-4">
        <div class="row row-cols-1 row-cols-md-2 
                    row-cols-lg-3 g-4">
        @foreach (var approval in approvals)
        {
            <DocumentApproveCard 
                Approval="approval"
                Approve="OnApprove"
                />
        } 
    </div>
</div>


@code {
    [Parameter]    
    public int documentId { get; set; }

    [Inject]
    public ApprovalService approvalService { get; set; }

    [Inject]
    NavigationManager navigationManager { get; set; }

    [Inject]
    AuthenticationStateProvider authenticationStateProvider { get; set; }

    [CascadingParameter]
    HttpContext httpContext { get; set; }

    private AuthedUser authedUser { get; set; }

    List<ApprovalOut> approvals = new();


    protected override async Task OnInitializedAsync()
    {

        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            authedUser = authState.User.Adapt<AuthedUser>();
        }

        approvals = approvalService.GetAllByDocument(documentId).OrderBy(a => a.IsApproved).ToList();
        if (authedUser.Role != Role.Admin 
            && approvals.Count(a => a.UserId == authedUser.Id || a.Document.OwnerId == authedUser.Id) == 0) 
            httpContext.Response.Redirect("/403");
    }

    public void OnApprove(ApproveDocumentModel approveDocument)
    {
        var approved = approvalService.Approve(approveDocument.Id);
        var index = approvals.FindIndex(a => a.Id == approved.Id);
        approvals.RemoveAt(index);
        approvals.Insert(index, approved);
        StateHasChanged();
    }
}